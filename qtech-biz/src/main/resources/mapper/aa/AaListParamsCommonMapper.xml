<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.qtech.aa.mapper.AaListParamsCommonMapper">
    <resultMap id="aaListParamsCommonResult" type="AaListParamsCommon">
        <result property="factoryName" column="company_name"/>
        <result property="workshopName" column="group_name"/>
        <result property="deviceType" column="devicetype"/>
    </resultMap>

    <sql id="selectEmsEqInfoListVo">
        select company_name,
               group_name,
               device_m_id as eq_id,
               machine_no  as mc_id,
               prod_type,
               pbox_id     as sim_id
        from (select sim_id, prod_type
              from (select sim_id, prod_type, chk_dt, row_number() over(partition by sim_id order by chk_dt desc) "num"
                    from qtech_eq_ods.equipment_reverse_control_info
                    where chk_dt > date_sub(now(), interval 30 day)) t
              where num = 1) a,
             (select a.device_id,
                     b.company_name,
                     b.dep_name,
                     b.group_name,
                     a.device_m_id,
                     devicetype,
                     a.devicename,
                     devicenetip,
                     c.pbox_id,
                     machine_no
              from qtech_eq_ods.ems_t_device a
                       inner join qtech_eq_ods.ems_t_pbox_info c on c.dev_id = cast(a.device_id as double)
                       left join qtech_eq_ods.ems_v_code_name b on a.hierarchy_code = b.hierarchy_show_code
                       left join qtech_eq_ods.ems_t_collector_program d on c.collector_program_id = d.id) b
        where a.sim_id = b.pbox_id
        order by company_name, group_name;
    </sql>

    <select id="getFactoryName" resultMap="aaListParamsCommonResult">
        select distinct b.company_name
        from qtech_eq_ods.ems_t_device a
                 left join qtech_eq_ods.ems_v_code_name b on
            a.hierarchy_code = b.hierarchy_show_code
        where devicetype in ('AA', 'DB', 'HM', 'HM')
    </select>

    <select id="getWorkshopName" resultMap="aaListParamsCommonResult">
        select
            distinct b.group_name
        from
            qtech_eq_ods.ems_t_device a
        left join qtech_eq_ods.ems_v_code_name b on
            a.hierarchy_code = b.hierarchy_show_code
        <where>
            and b.dep_name = 'COB车间'
            <if test="companyName != null and companyName != ''">and company_name = #{companyName}</if>
        </where>
    </select>
</mapper>