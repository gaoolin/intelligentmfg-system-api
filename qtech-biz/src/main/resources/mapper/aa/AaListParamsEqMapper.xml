<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.qtech.aa.mapper.AaListParamsEqMapper">
    <resultMap id="aaListParamsEqResult" type="AaListParamsEq">
        <result property="id" column="id"/>
        <result property="factoryName" column="company_name"/>
        <result property="groupName" column="group_name"/>
        <result property="eqId" column="eq_id"/>
        <result property="mcId" column="mc_id"/>
        <result property="prodType" column="prod_type"/>
        <result property="simId" column="sim_id"/>
        <result property="status" column="status"/>
        <result property="source" column="source"/>
        <result property="opCnt" column="op_cnt"/>
        <result property="remark" column="remark"/>
        <result property="updateBy" column="update_by"/>
        <result property="updateTime" column="update_time"/>
        <result property="createBy" column="create_by"/>
        <result property="createTime" column="create_time"/>
    </resultMap>

    <sql id="selectAaListParamsEqListVo">
        select company_name,
               group_name,
               device_m_id as eq_id,
               machine_no  as mc_id,
               prod_type,
               pbox_id     as sim_id,
               status,
               op_cnt,
               update_time,
               update_by,
               remark
        from (select sim_id, prod_type
              from (select sim_id, prod_type, chk_dt, row_number() over(partition by sim_id order by chk_dt desc) "num"
                    from qtech_eq_ads.im_eq_reverse_control_info
                    where chk_dt > date_sub(now(), interval 3 day)) t
              where num = 1) a,
             (select a.device_id,
                     b.company_name,
                     b.dep_name,
                     b.group_name,
                     a.device_m_id,
                     devicetype,
                     a.devicename,
                     devicenetip,
                     c.pbox_id,
                     machine_no,
                     e.status,
                     e.op_cnt,
                     e.update_time,
                     e.update_by,
                     e.remark
              from (select * from qtech_eq_ods.ems_t_device where devicetype = 'AA') a
                       inner join qtech_eq_ods.ems_t_pbox_info c on c.dev_id = cast(a.device_id as double)
                       left join qtech_eq_ods.ems_v_code_name b on a.hierarchy_code = b.hierarchy_show_code
                       left join qtech_eq_ods.ems_t_collector_program d on c.collector_program_id = d.id
                       left join qtech_eq_ads.im_eq_reverse_ignore_info e on c.pbox_id = e.sim_id) b
        where a.sim_id = b.pbox_id
    </sql>

    <insert id="upsertAaListParamsEq" parameterType="AaListParamsEq">
        insert into qtech_eq_ads.im_eq_reverse_ignore_info
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="simId != null">sim_id,</if>
            source,
            <if test="status != null">status,</if>
            <if test="opCnt != null">op_cnt,</if>
            <if test="updateTime != null">update_time,</if>
            <if test="updateBy != null">update_by,</if>
            <if test="remark != null">remark,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="simId != null">#{simId},</if>
            'aa-list',
            <if test="status != null">#{status},</if>
            <if test="opCnt != null">#{opCnt},</if>
            <if test="updateTime != null">#{updateTime},</if>
            <if test="updateBy != null">#{updateBy},</if>
            <if test="remark != null">#{remark},</if>
        </trim>
    </insert>

    <update id="editAaListParamsEq">
        update qtech_eq_ads.im_eq_reverse_ignore_info
        <trim prefix="set" prefixOverrides=",">
            <if test="status != null">status = #{status},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
            <if test="updateBy != null">update_by = #{updateBy},</if>
            op_cnt = COALESCE(op_cnt, 0) + 1
        </trim>
        where sim_id = #{simId} and source = 'aa-list'
    </update>

    <select id="selectAaListParamsEqById" resultMap="aaListParamsEqResult">
        select *
        from qtech_eq_ads.im_eq_reverse_ignore_info
        where sim_id = #{simId} and source = 'aa-list'
    </select>

    <select id="selectAaListParamsEqList" resultMap="aaListParamsEqResult">
        select * from (<include refid="selectAaListParamsEqListVo"/>) tmp
        <where>
            <if test="eqId != null and eqId != ''">and eq_id = #{eqId}</if>
            <if test="mcId != null and mcId != ''">and mc_id = #{mcId}</if>
            <if test="simId != null and simId != ''">and sim_id = #{simId}</if>
            <if test="factoryName != null and factoryName != ''">and company_name = #{factoryName}</if>
            <if test="groupName != null and groupName != ''">and group_name = #{groupName}</if>
            <if test="prodType != null and prodType != ''">and prod_type = #{prodType}</if>
            <if test="status != null">
                and (status = #{status} or (#{status} = 0 and status is null))
            </if>
        </where>
        order by update_time desc, status desc, company_name, group_name, mc_id
    </select>

</mapper>